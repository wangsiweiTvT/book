---
layout: post
title: 数据可视化
---

数据可视化非常重要。一张好的图，会清楚地传递一个 Message。为了达到这个目的，我们要合理地选择轴的尺度，进行平滑、合并，做好比较，写好图的标题和标注。这样我们的图才能清楚地表达我们的 Message。

## 选择尺度来揭示结构

我们应该合理地调整轴的取值范围，展现我们想要展示的图的结构的细节。一张图不够，就画两张图。

轴要不要从 0 开始呢？不一定。有的时候，为了减少空白空间，增加展示的空间，可以不从 0 开始，这样可以展示更多的细节。但是，Bar 图一般还是从 0 开始，以方便比较。比例也最好从零开始。

对轴做 Log 变换经常有很多好处。Log 可以显示小数的细节。Log 还能让我们发现数据中隐藏的结构。比如对横轴做 Log 后，如果显示是线性的话，那就是 y = logx，这个叫 Linear-Log（线性 Log）。如果把纵轴 Log 后，是线性的话，那就是 $$y = b^{ax}$$，这个叫 Log- Linear（Log 线性）。如果横轴和纵轴都做 Log 后是线性的话，那就是 $$y=x^a$$，这个叫 Log-Log，也叫 “幂率”（Power Law）。幂率是一个很常见的分布，比如说城市的人口、个人的收入通常是幂率分布的。

## 平滑和聚合数据

简单地画出原始数据，很可能因为大量的数据重叠到一起，以致看不出数据的内在结构和疏密。这时可以用 KDE 曲线、hexbin 图、kdeplot 等高线图，描绘平滑后的密度效果。也可以分组求平均后，画出平均后的效果。如下面是分组然后求均值的代码：

```py
times = (
    runners_over_17
      .assign(age_5yr=runners_over_17['age'] // 5 * 5)
      .groupby('age_5yr')['time']
      .mean()
      .reset_index()
)
px.line(times, x='age_5yr', y='time',
    labels={'time':"Average race time (sec)", 
        'age_5yr':"Runner age (5-yr)"},
    markers=True, 
    width=350, height=250)
```

注意，当数据较少时，应该画出每个原始的数据点，而不是进行平滑。因为这时平滑不仅没有意义，而且会带来错误的结果。此时，可以用 rug 图、strip 图。

## 促进有意义的比较

比较是一种强有力的传递 Message 的方法。为了凸显不同，我们可以采用下面的可视化方法。

首先，在位置上，把两个要比较的值，放到一起。比如 Bar 图，可以把两个数据的 Bar 紧挨着，并且用颜色突出是了个数据。但更直接的是把两个值垂直对齐，这样谁高谁低，就更一目了然了。然后，如果通过线图，把同类数据连起来，就可以比较两条连线。因为人的眼睛对线条展示的趋势非常敏感，所以这样做还可能让我我们有新的发现。

其次，为了更好地展示高低顺序，我们可以调整 Bar 图、Box 图的排列，让它们从低到高排列，这样比较好分清大家的高低顺序。

然后，目前比较流行的堆叠图，其实不适合比较，并不推荐，还不如直接画线图，然后进行比较。

此外，注意选择合适的调色盘，用有对比的颜色，来显示比较。选择舒服的颜色。避免色盲无法识别的颜色，因为有 10%的男性是红绿色盲。然后颜色不能太多，因为人们一般来说很难区分超过七种颜色。在 https://colorbrewer2.org 上有一些配色方案可以选。

最后，尽量用 Bar 图代替饼图。饼图是通过角度来显示信息的，它有三个问题。首先，视觉上来说，角度的大小关系不容易判断，所以，如果画饼图的话，那么一定要再加上标注，清楚地显示百分比；其次，饼图的排列失去了大小顺序；最后，占比较小的类别，显示很不清晰。因此，饼图中最好只有 2 或 3 个切片，并按比例的顺序排列。然后，最好不用饼图，而是用 Bar 图，因为饼图能显示的内容，Bar 都能显示，而且更加清晰、准确。

### Q-Q 图

如果想要比较两个数据的分布是不是一样，可以用 q-q 图。注意，不能画两个直方图，然后去观察它们的形状是否相同。这种方法不准确。q-q 图是最专业的方法。画 q-q 图的代码如下。注意，我们还画了一根通过原点的、斜率为 1 的参考线，方便比较。

q-q 图画出来后，如果是直的，那么这两个分布的形状就一样。如果这根直线与参考线平行，那么这两个分布的中心点（Center）有差异。如果这根直线的斜率不为 1，表示两个分布的 Spread 有差异。

```py
br2 = sfh.query('br == 2')
br4 = sfh.query('br == 4')

percs = np.arange(1, 100, 1)
perc2 = np.percentile(br2['price'], 
    percs, method='lower')
perc4 = np.percentile(br4['price'], 
    percs, method='lower')
perc_sfh = pd.DataFrame({'percentile': percs, 
    'br2': perc2, 'br4': perc4})

fig = px.scatter(perc_sfh, x='br2', y='br4', 
        log_x=True, log_y=True, 
        labels={'br2': 'Price of 2-bedroom house',
            'br4': 'Price of 4-bedroom house'},
        width=350, height=250)
fig.add_trace(go.Scatter(x=[1e5, 2e6], y=[1e5, 2e6], 
    mode='lines', line=dict(dash='dash')))
fig.update_layout(showlegend=False)
fig
```

## 数据设计

在可视化时，要留心数据的 Scope。比如，在显示房价的时候，可能应该考虑通胀对数据的影响，因此，调整数据，去除这个影响。又比如，通过平均值来观察两个变量关系时，要注意平均值反映的信息有限，还可以观察更多的百分位数，这样能够看到更多的情况。此外，注意控制变量，可以对各个类别的数据分别进行分析，防止辛普森悖论带来的问题。最后，考虑样本权重。比如全体人口中女性比例是 51%，但我们的测量数据中，女性比例是 40%，那么就要对结果进行调整，才能得到适合全体人口的准确估计。

## 添加上下文

最后，我们应该写好图的标题，并在图上加必要的文本标注，凸显我们想要传递的 Message。比如我们画一张百米赛跑的成绩图，就可以在图上标出哪个点是博尔特创造的，然后在标题里清楚地写出我们要表达的意思：自从博尔特跑出这个世界记录以后，后面再没有被超越过。特别是我们写论文的时候要这么做，因为写论文最重要的就是让别人看懂，所有要
努力给图片加背景信息。

## 可视化工具

在 Python 里，最常用的是 matplotlib 和 seaborn，但我们主要是用 plotly 画。plotly 有两个好处。首先，它画出来的是我们可以和它交互的图，比如我们可以用鼠标去点数据点，看它的数据，这样就比较方便。其次，它可以用 SVG 的格式保存图。大家保存图的时候，喜欢截屏。截屏获得的图，是关于像素点的图，因此在放大时，就会虚，而 SVG 是矢量图，不论怎么放大，都不会虚，都很清楚。所以大家如果去看论文的图，基本上都是 SVG 的图。

## 小结

总之，可视化非常重要。大家注意看那些顶会、顶刊的论文，比如 Nature 期刊，它的图都画得特别好的。我们基于上面学习到的一般规律，平时留意别人的图，多学习，多练习，就能画出很好的图。

<br/>

|[Index](../) | [Previous](11-eda) | [Next](15-air-quality) |
