---
layout: post
title: 仿真和数据设计
---

本节仿真与实验设计。我们学习随机抽样的 Urn 模型，并用三个例子，说明随机仿真中偏差和精度带来的问题，如何比较两个实验结果，如何基于仿真进行假设检验，以及评估测量仪器的精度。

## 随机抽样的 Urn 模型

随机抽样遵循 Urn 模型。这个模型是 Jacob Bernoulli 在 18 世纪早期提出的，即：碗里有很多的球，你就在里面随机地采样。

随机采样有两种方式：一种是有放回的，就是拿出一个，记下它的颜色后，又把它放回去；一种是不放回的，即拿出后，就不放回了，就少一个这样的了。请问大家，假设我在咱们 80 个同学里面一次请 10 个同学回答问题，请问这是有放回的，还是不放回的？是不放回的，对吧？如果我是每次找一个同学出来回答问题。他回答完后，坐下，我又在所有的同学里随机找一个人出来回答（也可能再找到前面回答过问题的同学），一共找了10次，这个是有放回的，对吧。

这两种采样的结果模型是不一样的啊。大家学过二项分布吧？二项分布是有放回的。但我们做调研经常是无放回的。这符合超几何分布。

我们下面学习基于 Python 的随机采样仿真代码。首先，numpy 里面有个库叫 random，是个随机库。里面有个函数叫做 choice，可以做随机采样。然后，Python 有一个特别有意思的语法，用一行 for 语句就能运行随机采样一万次，然后把结果放到list 里头。不需要咱们写个 for 循环，然后再一个个往里面 append。这样会特别慢。这个是个技巧。请大家掌握。

```py

import numpy as np

n = 10_000

urn = ["b", "b", "b", "w", "w"]

samples = [np.random.choice(urn, size=2, 
      replace=False) for _ in range(n)]

is_matching = [marble1 == marble2 for marble1, 
      marble2 in samples]

print(f"Proportion of samples with matching 
      marbles: {np.mean(is_matching)}")

Proportion of samples with matching marbles: 0.4032

```

Python 里面还有一个迭代库 itertools，里面有一个 combinations 函数，能够生成各种组合。比如说你送进去 “abcdefg” 和一个 3，它就会给出其中任意三个的字符的组合。注意它是组合，不是排列。它是没有顺序的。

```py

from itertools import combinations
  all_samples = ["".join(sample) for sample in 
      combinations("ABCDEFG", 3)]

 print(all_samples)

['ABC', 'ABD', 'ABE', 'ABF', 'ABG', 'ACD', 
'ACE', 'ACF', 'ACG', 'ADE', 'ADF', 'ADG', 'AEF', 
'AEG', 'AFG', 'BCD', 'BCE', 'BCF', 'BCG', 'BDE', 
'BDF', 'BDG', 'BEF', 'BEG', 'BFG', 'CDE', 'CDF', 
'CDG', 'CEF', 'CEG', 'CFG', 'DEF', 'DEG', 'DFG', 
'EFG']

```

排列是 permutation 函数，它的用法如下：

```py
from itertools import permutations

print(["".join(sample) for sample in 
    permutations("ABC")])

['ABC', 'ACB', 'BAC', 'BCA', 'CAB', 'CBA']
```

你看，它给的结果，就考虑顺序了。这些都是我们做仿真的时候用得着的。

抽样的话，有两种：

一种是分层抽样：把样本分为不重叠的层，在各层中简单抽样。比如说我把大家分成博士、硕士、本科三层，或者分成 80 岁以上、60～80岁、60岁以下三层。然后在每一层中间随机抽。这样保证每一层同学都会被抽到。

一种是聚类采样：把样本分为不重叠的簇，每次随机选一个簇。比如说我把土建系的同学放到一起，经济系的同学放到一起，物流的放在一起，然后我每次随机抽一组同学出来答题。

无放回的抽样，符合超几何分布（hypergeometric distribution）。numpy 的 random.hypergeometric 函数可以生成它的随机变量。如下面的代码所示：

```py
simulations_fast = np.random.hypergeometric(
      ngood=4, nbad=3, nsample=3, size=10_000
  )
print(simulations_fast)
  [1 1 2 ... 1 2 2]
```

也可以用 scipy 的 stats 库里的 hypergeom 函数，来计算抽样结果的概率。代码如下：

```py
from scipy.stats import hypergeom
  num_failures = [0, 1, 2, 3]
  pd.DataFrame({
      "Number of failures": num_failures,
      "Fraction of samples": hypergeom.pmf
      (num_failures, 7, 4, 3),})

    Number of Failures    Fraction of Samples
  0        0                    0.03
  1        1                    0.34
  2        2                    0.51
  3        3                    0.11
```

## 随机取样的民调仿真

第一个例子，仿真民调。说明在随机取样时，得到的结果的变化（Variation），以及 Bias 对结果的影响。

我们首先来看一下，怎么仿真民意调查。我们仿真 600 万人，假设采样 1500 人。我们首先指定三种人：一种是支持希拉里的，一种是支持特朗普的，还有一种是谁也不支持的。
其中，支持特朗普的人比支持希拉里的人多一点点，但就一点点。

```py
proportions = np.array([0.4818, 0.4746, 
      1 - (0.4818 + 0.4746)])

N = 6_165_478

votes = np.trunc(N * proportions).astype(int)

array([2970527, 2926135,  268814])
```

我们然后在 600 万人中，随机采样 1500 人。因为是不放回的采样，我们用多变量超几何分布的采样函数 rvs 进行采样。

```py
from scipy.stats import multivariate_hypergeom
n = 1_500
votes = array([2970527, 2926135, 268814])
multivariate_hypergeom.rvs(votes, n)
array([727, 703, 70])
```

运行 1 万次仿真，我们会发现其中有 40% 的采样，希拉里是赢的。这就是仿真结果的 Variation。

我们然后加上一点点 bias，给希拉里的概率加一点点，就是 0.005，这时再仿真，就发现 56% 的采样中，希拉里赢了。这就是“偏差”带来的影响。这个偏差是增加仿真次数，不能改进的。专家们后来发现，在实际中，民调的 Bias 有 1.5% 是很正常的。

通过这个例子，以后大家就会看民调了吧？特别是现在都极化特别严重，两方势均力敌的情况下，我们要学会看民调。

## 疫苗有效性的比较和仿真

第二个例子，比较两种疫苗。一种疫苗实验结果有效性 90%，另一种疫苗实验结果有效性 60%，那么，真的是这个 60% 的疫苗，性能不如那个 90% 的疫苗吗？专业人士会怎么看？我们也介绍验证疫苗有效性的实验方法，并通过仿真，验证疫苗的有效性。

我们下面再看一个经常遇到的问题，就是我们疫情期间遇到的：有两种疫苗，到底打哪一种啊？为了解决这个问题，我们就收集了两种疫苗的数据：一种有效率 95%，一种有效率 65%。我们接下来怎么比较这两个结果呢？

按照我们前面学过的，我们首先要搞清楚这些实验数据的 Scope 是什么，对吧？我们要问问题：谁测的，测谁的，什么时候测，在哪里测的，等等。

一旦大家问这个问题，就会发现：这个有效性 65% 的疫苗 A 啊，针对的是 18 岁及以上成年人，这些人里，有 40% 是患有与患严重新冠风险增加相关的疾病的，比如本来就可能有呼吸系统疾病、心细管疾病。实验的时间呢，是 2020 年 10 月到 11 月。大家想想，这个时间，我们是什么情况呢？实验的地点呢包括三个州，八个国家，特别是它包括了美国和南非。大家想想南非，是不是咱们那些最厉害的变种，都是南非来的？这是你问的那些数据 Scope 的问题后，疫苗 A 的回答。

我们在看疫苗 B。它主要是在美国实验的。美国医疗条件相对较好。49% 的实验者有继往病史。它的测量时间是在 2020 年夏季的早期。这个时候啊，病毒还没有 10 月那么厉害，病例处于低点，但到了 10月份，就迅速增加了。这是你问的那些数据 Scope 的问题后，疫苗 B 的回答。

比较上面的两个疫苗实验的 Scope 的回答，你是不是就感觉不能简单说疫苗 A 没有疫苗B 有效了吧？确实是这样的。特别是，夏季的时候，新冠还比较轻，到秋季的时候，厉害的新冠才上来了。这是一点。然后，在疫苗 A 在南非试验的时候，厉害的病毒变种正好起来。所以疫苗 A 其实也很可能是非常有效的。

上面的例子说明，我们问数据 Scope 的问题，是非常有用的吧。不能简单地认为 65 低于95，所以疫苗 A 就比疫苗 B 差啊。这才是专业的态度。

下面我们来仿真验证疫苗 A 的效果。医学界是这么实验的：一共招募了 43738 个志愿者。其中一半打疫苗 A，一半打安慰剂。过了 4 周以后，再去看这 4 万个志愿者，发现其中有 468 个人得了新冠，其中 117 个是打了疫苗的，351 个是没有打疫苗的。这是它的测量结果。现在请大家判断，这个疫苗 A 到底有用吗？

基于上面的实验结果，来验证疫苗 A 的效果，我们要用到“假设检验”。科学的假设检验的方法是这样的：我先假设这个疫苗没用（NULL假设），然后我们仿真，看看按着这个假设，实验结果出现的可能性。如果可能性很小，就说明我们的假设可能不太成立，因此，疫苗有很大的概率是有效的。我们下面就来用仿真做这个假设检验。

按照我们前面仿真民调的结果，我们知道，即使疫苗没有用，也可能得到实验的结果。也就是说，疫苗没有用，所以 468 个人得新冠，他们是随机得的。我们就仿真这种情况。然后看“117 个人属于打了疫苗的人群”这种情况出现的概率。

因此，这个仿真的办法跟前面的仿真是一样的。我们把 43738 个志愿者，其中 468 个人是病人，其余 43270 人是好人。我们从中不放回地随机取样 21869 人（就是一半人），然后看这些人中，病人的数目。一共仿真 50万次。代码如下：

```py
imulations_fast = np.random.hypergeometric
        (ngood=468, nbad=43270, 
        nsample=21869, size=500000)
```

上述代码，会给出 50 万个数。每个数是一次实验中，病人的个数。我们画出它的直方图，发现基本上没有出现过病人数少于 200 的情况。但实验结果却显示病人数为 117 人，这概率就更小了。所以我们的假设（即疫苗是无效的）成立的可能性很小。我们可以比较放心地拒绝（reject）这个假设。即疫苗还是很有效果的。

这就是假设检验的套路：先定义一个 Null 假设，认为这个东西没用，然后根据这个假设进行仿真，结果发现此时我的实验结果不太可能出现，这样我就可以拒绝（reject）掉Null 假设。这是个特别重要的技巧。希望大家掌握。

小结一下。在这个疫苗的例子里，我们学到两个东西：第一，不能看到一个看起来有数据支撑的结果，就觉得它很有道理，而是要专业地问问题，问它的数据 Scope；第二，我们学会了怎么做仿真，来做假设检验。这很有用。

## 空气质量测量仪的性能评估

第三个例子，评估家用空气质量测量仪测量结果的 Variation。

我们每两分钟测一次，然后画出子夜、中午、下午各半个小时的测量结果。从图中我们可以看出，测量的结果确实会变。为了评估其变化情况，我们算各测量值相对于半个小时的中值的偏离比值，画出它的直方图，发现大多数情况下，都比 0.5 要小。我们然后算一下它的标准差，得到 0.68，也比较小。

评估变化情况还有一个很重要的指标，叫做相对标准差，就是拿它的标准差除上它的均值。我们发现结果是 8% 到 12%。一般来说 10% 左右都是还好的。因此，我们认为设备的精度还可以。

这是一种常见的评估设备精度的方法。

## 小结

本节我们学习了仿真的 Urn 模型，然后通过三个示例，理解了随机仿真的 Bias、Variation，理解了要分析实验结果的数据 Scope，学会了利用仿真进行假设检验，学会了如何测量设备的 Variation。

<br/>

|[Index](../) | [Previous](13-4-protocol) | [Next](13-7-model)|

